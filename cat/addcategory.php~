<?php
// This file is part of Moodle - http://moodle.org/
//
// Moodle is free software: you can redistribute it and/or modify
// it under the terms of the GNU General Public License as published by
// the Free Software Foundation, either version 3 of the License, or
// (at your option) any later version.
//
// Moodle is distributed in the hope that it will be useful,
// but WITHOUT ANY WARRANTY; without even the implied warranty of
// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
// GNU General Public License for more details.
//
// You should have received a copy of the GNU General Public License
// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.

require_once('../../config.php');
require_once('addcategory_form.php');
require_once($CFG->dirroot.'/lib/moodlelib.php');


$PAGE->https_required();

$mycatid = required_param('mycat', PARAM_INT);
// Add course module id as a required parameter 
$cmid = required_param('cmid', PARAM_INT);
$mycat = $DB->get_record('mycat', array('id'=>$mycatid), '*'/*, MUST_EXIST*/);
$course = $DB->get_record('course', array('id'=>$mycat->course), '*'/*, MUST_EXIST*/);


// A parameter which holds the id of this category
// If its -1 the it means we create a new category
$id = optional_param('id', -1, PARAM_INT);
if ($id == 0)
	$id = -1;

// Set course will add a "Course name" button on the footer of the page to redirect back
// to course main page.  If $SITE is used, that button will be "Home"
if ($course) {
	$PAGE->set_course($course);
} else {
	$PAGE->set_course($SITE);
}


/* Set the url */
$PAGE->set_url('/mod/mycat/addcategory.php', array('mycat'=>$mycatid, 'cmid'=>$cmid, 'id'=>$id));


//$PAGE->set_context(get_context_instance(CONTEXT_MODULE, $mycatid));
//$PAGE->set_context(get_context_instance(CONTEXT_USER, $USER->id));
//$PAGE->set_pagelayout('maintenance'); // admin

require_login();

$PAGE->navbar->includesettingsbase = true;

// Setting the action url is required when we have parameters on our form.  After submission/cancellation
// we will redict to the url given below (which includes the parameters).
// If we dont send actionurl then by default would be 'addcategory.php' (no parameters) and that would
// cause error
$actionurl = $CFG->wwwroot . '/mod/mycat/addcategory.php?mycat=' . $mycatid . '&cmid=' . $cmid
. '&id=' . $id ;
$theform = new mycat_addcategory_form($actionurl);
$oldcategory = null;
if ($id > 0) {
  $oldcategory = $DB->get_record('mycat_category', array('id'=>$id), '*', MUST_EXIST);
  $theform->set_data($oldcategory);
}
else { // We have to fill the priority field
  $theform->set_data(array('priority'=> $mycat->nextpriority, 'mycatid' => $mycatid));
}


//$PAGE->verify_https_required();

// Check if data submitted and take appropriate actions
$datasubmitted = $theform->get_data();

if ($theform->is_cancelled()) {
  redirect($CFG->wwwroot . '/mod/mycat/view.php?id=' . $cmid);
	
}
else if ($datasubmitted) {
	if ($datasubmitted->priority >= $mycat->nextpriority) {
		if ($id > 0) {
		  $datasubmitted->priority=$oldcategory->priority;
		} 
		else {
		  $datasubmitted->priority = $mycat->nextpriority;
		  $mycat->nextpriority++;
		}
	} 
	else if ($datasubmitted->priority < $mycat->nextpriority) {
	  
	  if ($id > 0 && $datasubmitted->priority != $oldcategory->priority) {
		  $swapobject = $DB->get_record('mycat_category', array('mycatid'=>$mycat->id, 'priority'=>$datasubmitted->priority), '*', MUST_EXIST);
			$swapobject->priority = $oldcategory->priority;
			$DB->update_record('mycat_category', $swapobject);
		}
		else if ($id <=0) {
			$swapobject = $DB->get_record('mycat_category', array('mycatid'=>$mycat->id, 'priority'=>$datasubmitted->priority), '*', MUST_EXIST);
	   	$swapobject->priority = $mycat->nextpriority;
			$DB->update_record('mycat_category', $swapobject);
			$mycat->nextpriority++;
		}
	}

	// This is a new record
	if ($id == -1) {
	  // Add submitted data to the database
	  $DB->insert_record('mycat_category', $datasubmitted);
	  $mycat->total += $datasubmitted->maxgrade;
	}
	else {
		$DB->update_record('mycat_category', $datasubmitted);
	}
	$DB->update_record('mycat', $mycat);
	redirect($CFG->wwwroot . '/mod/mycat/view.php?id=' . $cmid);
}


/// Display page header
/* 
if ($user->id == -1 or ($user->id != $USER->id)) {
    if ($user->id == -1) {
        echo $OUTPUT->header();
    } else {
        $PAGE->set_heading($SITE->fullname);
        echo $OUTPUT->header();
        $userfullname = fullname($user, true);
        echo $OUTPUT->heading($userfullname);
    }
} else */if (!empty($USER->admin)) {
    $strinstallation = get_string('installation', 'install');
    $strprimaryadminsetup = get_string('primaryadminsetup');

    $PAGE->navbar->add($strprimaryadminsetup);
    $PAGE->set_title($strinstallation);
    $PAGE->set_heading($strinstallation);
    $PAGE->set_cacheable(false);

    echo $OUTPUT->header();
    echo $OUTPUT->box(get_string('configintroadmin', 'admin'), 'generalbox boxwidthnormal boxaligncenter');
    echo '<br />';
} else {
    //$streditmyprofile = get_string('editmyprofile');
    //$strparticipants  = get_string('participants');
    //$strnewuser       = get_string('newuser');
    $userfullname     = fullname($USER, true);

    $PAGE->set_title("Add category: Create a new one");
    $PAGE->set_heading("Add/Edit a category");

    echo $OUTPUT->header();
    echo $OUTPUT->heading($userfullname);
}


//echo $OUTPUT->header();

/// Finally display THE form
$theform->display();



/// and proper footer
echo $OUTPUT->footer();
